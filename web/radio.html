<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìª</text></svg>">    <title>Radio Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .radio-unit {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.8),
                inset 0 1px 0 rgba(255,255,255,0.1);
            max-width: 650px;
            width: 100%;
            border: 2px solid #000;
        }
        
        .display-area {
            background: #ff8c00;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 
                inset 0 2px 8px rgba(0,0,0,0.6),
                0 0 20px rgba(255,140,0,0.4);
            border: 2px solid #333;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
        }

        .indicator-dot.connected {
            background: #00aa00;
            box-shadow: 0 0 6px #00aa00;
        }

        .indicator-dot.disconnected {
            background: #aa0000;
            box-shadow: 0 0 6px #aa0000;
        }

        .indicator-text {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #000;
            letter-spacing: 1px;
            opacity: 0.7;
        }
        
        .station-info {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #000;
            text-align: right;
            letter-spacing: 2px;
            margin-bottom: 5px;
            opacity: 0.7;
        }
        
        .station-display {
            font-family: 'Courier New', monospace;
            font-size: 32px;
            font-weight: bold;
            color: #000;
            text-align: center;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }
        
        .station-display.scrolling {
            text-align: left;
        }
        
        .station-display.scrolling span {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-text 20s linear infinite;
        }
        
        @keyframes scroll-text {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        .status-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #000;
            text-align: center;
            letter-spacing: 2px;
            min-height: 20px;
            opacity: 0.8;
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .control-button {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 2px solid #444;
            color: #ff8c00;
            padding: 15px;
            border-radius: 6px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.1s;
            flex: 1;
            box-shadow: 
                0 3px 0 #000,
                inset 0 1px 0 rgba(255,255,255,0.1);
            font-weight: bold;
        }
        
        .control-button:hover:not(:disabled) {
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
            transform: translateY(1px);
            box-shadow: 
                0 2px 0 #000,
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .control-button:active:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 
                0 0 0 #000,
                inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-button.active-state {
            border-color: #ff8c00;
            background: linear-gradient(180deg, #4a4a4a 0%, #2d2d2d 100%);
            box-shadow:
                0 2px 0 #000,
                0 0 10px rgba(255, 140, 0, 0.5),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .control-button.danger {
            color: #ff5c5c;
            border-color: #663333;
        }

        .control-button.danger:hover:not(:disabled) {
            background: linear-gradient(180deg, #4a2a2a 0%, #2a1a1a 100%);
        }
        
        .tuner-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .tuner-group {
            flex: 1;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #333;
        }
        
        .tuner-label {
            color: #ff8c00;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .tuner-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tuner-display {
            background: #0d0d0d;
            color: #ff8c00;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #444;
            letter-spacing: 3px;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .keypad-button {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 2px solid #444;
            color: #ff8c00;
            padding: 10px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 
                0 3px 0 #000,
                inset 0 1px 0 rgba(255,255,255,0.1);
            font-weight: bold;
        }
        
        .keypad-button:hover:not(:disabled) {
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
            transform: translateY(1px);
            box-shadow: 
                0 2px 0 #000,
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .keypad-button:active:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 
                0 0 0 #000,
                inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .keypad-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .keypad-button.active {
            border-color: #ff8c00;
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
        }
        
        .keypad-button:nth-child(10) {
            grid-column: 2;
        }
        
        .play-button {
            background: linear-gradient(180deg, #ff8c00 0%, #d97500 100%);
            border: 2px solid #333;
            color: #000;
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 
                0 4px 0 #8b4500,
                inset 0 1px 0 rgba(255,255,255,0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .play-button:hover:not(:disabled) {
            background: linear-gradient(180deg, #ffa520 0%, #e08000 100%);
            transform: translateY(1px);
            box-shadow: 
                0 3px 0 #8b4500,
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .play-button:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 
                0 0 0 #8b4500,
                inset 0 2px 6px rgba(0,0,0,0.4);
        }
        
        .play-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .favorites-section {
            margin-bottom: 20px;
        }
        
        .favorites-label {
            color: #ff8c00;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .favorites-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .favorite-button {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 2px solid #444;
            color: #ff8c00;
            padding: 12px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 
                0 3px 0 #000,
                inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
        }
        
        .favorite-button:hover:not(:disabled) {
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
            transform: translateY(1px);
            box-shadow: 
                0 2px 0 #000,
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .favorite-button:active:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 
                0 0 0 #000,
                inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .favorite-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .favorite-button.saving {
            background: linear-gradient(180deg, #ff8c00 0%, #d97500 100%);
            color: #000;
            animation: pulse 0.5s ease-in-out;
        }
        
        .favorite-button.has-preset {
            border-color: #ff8c00;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .volume-section {
            margin-bottom: 20px;
        }
        
        .volume-label {
            color: #ff8c00;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .volume-control {
            display: flex;
            gap: 15px;
            align-items: center;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #333;
        }
        
        .volume-icon {
            color: #ff8c00;
            font-size: 20px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff8c00;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            border: 2px solid #000;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff8c00;
            cursor: pointer;
            border: 2px solid #000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        
        .volume-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #ff8c00;
            font-size: 18px;
            font-family: 'Courier New', monospace;
        }
        
        .branding {
            text-align: center;
            color: #666;
            font-size: 11px;
            margin-top: 20px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .success { color: #000; }
        .error { color: #8b0000; }
        .pending { color: #000; opacity: 0.6; }
    </style>
</head>
<body>
    <div class="radio-unit">
        <div class="display-area">
            <div class="connection-indicator" id="connectionIndicator">
                <span class="indicator-dot"></span>
                <span class="indicator-text">CONNECTING...</span>
            </div>
            <div class="station-info" id="stationInfo">Bank:  1 - Station:  1</div>
            <div class="station-display" id="stationDisplay">READY</div>
            <div class="status-display" id="status"></div>
        </div>
        
        <div class="controls-row">
            <button class="control-button" id="playBtn" onclick="sendCommand('mpc play')" title="Play">‚ñ∂</button>
            <button class="control-button" id="pauseBtn" onclick="sendCommand('mpc pause')" title="Pause">‚ùö‚ùö</button>
            <button class="control-button danger" id="shutdownBtn" onclick="requestShutdown()" title="Shutdown">‚èª</button>
        </div>
        
        <div class="tuner-section">
            <div class="tuner-group">
                <div class="tuner-label">Bank</div>
                <div class="keypad">
                    <button class="keypad-button" onclick="setBank(1)">1</button>
                    <button class="keypad-button" onclick="setBank(2)">2</button>
                    <button class="keypad-button" onclick="setBank(3)">3</button>
                    <button class="keypad-button" onclick="setBank(4)">4</button>
                    <button class="keypad-button" onclick="setBank(5)">5</button>
                    <button class="keypad-button" onclick="setBank(6)">6</button>
                    <button class="keypad-button" onclick="setBank(7)">7</button>
                    <button class="keypad-button" onclick="setBank(8)">8</button>
                    <button class="keypad-button" onclick="setBank(9)">9</button>
                    <button class="keypad-button" onclick="setBank(10)">10</button>
                </div>
            </div>
            
            <div class="tuner-group">
                <div class="tuner-label">Station</div>
                <div class="keypad">
                    <button class="keypad-button" onclick="setStation(1)">1</button>
                    <button class="keypad-button" onclick="setStation(2)">2</button>
                    <button class="keypad-button" onclick="setStation(3)">3</button>
                    <button class="keypad-button" onclick="setStation(4)">4</button>
                    <button class="keypad-button" onclick="setStation(5)">5</button>
                    <button class="keypad-button" onclick="setStation(6)">6</button>
                    <button class="keypad-button" onclick="setStation(7)">7</button>
                    <button class="keypad-button" onclick="setStation(8)">8</button>
                    <button class="keypad-button" onclick="setStation(9)">9</button>
                    <button class="keypad-button" onclick="setStation(10)">10</button>
                </div>
            </div>
        </div>
        
        <div class="favorites-section">
            <div class="favorites-label">Favorites (Hold to Save)</div>
            <div class="favorites-buttons">
                <button class="favorite-button" data-slot="1">1</button>
                <button class="favorite-button" data-slot="2">2</button>
                <button class="favorite-button" data-slot="3">3</button>
                <button class="favorite-button" data-slot="4">4</button>
                <button class="favorite-button" data-slot="5">5</button>
                <button class="favorite-button" data-slot="6">6</button>
            </div>
        </div>
        
        <div class="volume-section">
            <div class="volume-label">Volume</div>
            <div class="volume-control">
                <input type="range" id="volumeSlider" min="0" max="100" value="30">
                <span class="volume-value" id="volumeValue">30</span>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = (window.location.protocol === 'file:')
            ? 'http://localhost:8080'
            : window.location.origin;
        // Note: this backend does not require a per-request host field.
        let volumeDebounceTimer = null;
        let isCommandPending = false;
        let statusUpdateInterval = null;
        
        // Current selection
        let currentBank = 1;
        let currentStation = 1;
        let currentBankName = '';
        let currentStationName = '';
        
        // Favorites storage (localStorage)
        let favorites = {};
        let holdTimer = null;
        let holdSlot = null;
        
        // Tuner change debouncing
        let tunerDebounceTimer = null;
        
        // Config is not needed for the '(1)' backend
        function fetchConfig() { /* no-op */ }

        function debouncedPlayStation() {
            if (tunerDebounceTimer) {
                clearTimeout(tunerDebounceTimer);
            }
            
            // Update display immediately
            updateStationInfo();
            
            // Wait 300ms after last change before sending command
            tunerDebounceTimer = setTimeout(() => {
                playCurrentStation();
            }, 300);
        }
        
        // Load favorites from localStorage
        function loadFavorites() {
            const saved = localStorage.getItem('radioFavorites');
            if (saved) {
                favorites = JSON.parse(saved);
                updateFavoriteButtons();
            }
        }
        
        // Save favorites to localStorage
        function saveFavoritesToStorage() {
            localStorage.setItem('radioFavorites', JSON.stringify(favorites));
        }
        
        // Update visual state of favorite buttons
        function updateFavoriteButtons() {
            document.querySelectorAll('.favorite-button').forEach(btn => {
                const slot = btn.getAttribute('data-slot');
                if (favorites[slot]) {
                    btn.classList.add('has-preset');
                    // Show bank-station on button
                    btn.textContent = `${favorites[slot].bank}-${favorites[slot].station}`;
                } else {
                    btn.classList.remove('has-preset');
                    // Show just the slot number
                    btn.textContent = slot;
                }
            });
        }
        
        // Initialize favorite button handlers
        document.querySelectorAll('.favorite-button').forEach(btn => {
            const slot = btn.getAttribute('data-slot');
            
            // Mouse/touch down - start hold timer
            btn.addEventListener('mousedown', () => startHold(slot, btn));
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startHold(slot, btn);
            });
            
            // Mouse/touch up - cancel hold or trigger recall
            btn.addEventListener('mouseup', () => endHold(slot));
            btn.addEventListener('touchend', () => endHold(slot));
            btn.addEventListener('mouseleave', () => cancelHold());
        });
        
        function startHold(slot, btn) {
            holdSlot = slot;
            holdTimer = setTimeout(() => {
                // Held long enough - save favorite
                saveFavorite(slot);
                btn.classList.add('saving');
                setTimeout(() => btn.classList.remove('saving'), 500);
                
                // Clear hold state so endHold doesn't trigger recall
                holdTimer = null;
                holdSlot = null;
            }, 2000); // Hold for 2 seconds
        }
        
        function endHold(slot) {
            if (holdTimer) {
                clearTimeout(holdTimer);
                // Short press - recall favorite (only if we didn't just save)
                if (holdSlot === slot) {
                    recallFavorite(slot);
                }
                holdTimer = null;
                holdSlot = null;
            }
        }
        
        function cancelHold() {
            if (holdTimer) {
                clearTimeout(holdTimer);
                holdTimer = null;
                holdSlot = null;
            }
        }
        
        function saveFavorite(slot) {
            favorites[slot] = {
                bank: currentBank,
                station: currentStation
            };
            saveFavoritesToStorage();
            updateFavoriteButtons();
            
            // Show brief confirmation in status
            const oldStatus = document.getElementById('status').textContent;
            updateStatus(`SAVED TO ${slot}`, 'success');
            setTimeout(() => {
                updateStatus(oldStatus, 'normal');
            }, 2000);
        }
        
        function recallFavorite(slot) {
            if (favorites[slot]) {
                const fav = favorites[slot];
                currentBank = fav.bank;
                currentStation = fav.station;
                
                // Auto-play the favorite
                playCurrentStation();
            }
        }
        
        // Volume slider with debouncing
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        
        volumeSlider.addEventListener('input', function(e) {
            volumeValue.textContent = e.target.value;
            
            if (volumeDebounceTimer) {
                clearTimeout(volumeDebounceTimer);
            }
            
            volumeDebounceTimer = setTimeout(() => {
                sendCommand(`mpc volume ${e.target.value}`);
            }, 500);
        });
        
        function setBank(bank) {
            currentBank = bank;
            currentBankName = '';
            currentStationName = '';
            updateKeypadHighlights();
            debouncedPlayStation();
        }
        
        function setStation(station) {
            currentStation = station;
            currentBankName = '';
            currentStationName = '';
            updateKeypadHighlights();
            debouncedPlayStation();
        }
        
        function updateKeypadHighlights() {
            // Update bank keypad
            const bankKeypad = document.querySelectorAll('.tuner-group:nth-child(1) .keypad-button');
            bankKeypad.forEach((btn, index) => {
                const buttonValue = index < 9 ? index + 1 : 10; // 1-9, then 0 (which is 10)
                if (buttonValue === currentBank) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update station keypad
            const stationKeypad = document.querySelectorAll('.tuner-group:nth-child(2) .keypad-button');
            stationKeypad.forEach((btn, index) => {
                const buttonValue = index < 9 ? index + 1 : 10; // 1-9, then 0 (which is 10)
                if (buttonValue === currentStation) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function updateStationInfo() {
            const bankLabel = currentBankName || `${currentBank}`;
            const stationLabel = currentStationName || `${currentStation}`;
            document.getElementById('stationInfo').textContent = `Bank:  ${bankLabel} - Station:  ${stationLabel}`;
        }
        
        function playCurrentStation() {
            // Convert display numbers (1-10) to actual numbers (0-9) for the command
            playRadio(currentBank - 1, currentStation - 1);
        }
        
        function playRadio(bank, station) {
            //bank and station here are 0-9 (actual values)
            // Update internal state to show 1-10
            currentBank = bank + 1;
            currentStation = station + 1;
            currentBankName = '';
            currentStationName = '';
            updateStationInfo();
            updateKeypadHighlights();
            sendCommand(`radio-play ${bank} ${station}`);
            setTimeout(fetchRadioState, 350);
        }
        
        function updateStationDisplay(text) {
            const displayElement = document.getElementById('stationDisplay');
            
            // Check if text is longer than ~20 characters (needs scrolling)
            if (text.length > 20) {
                displayElement.innerHTML = `<span>${text}</span>`;
                displayElement.classList.add('scrolling');
            } else {
                displayElement.textContent = text;
                displayElement.classList.remove('scrolling');
            }
        }
        
        function updateStatus(message, type = 'normal') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status-display ' + type;
        }
        
        function setButtonsDisabled(disabled) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = disabled);
        }
        
        function updateConnectionIndicator(connected, message) {
            const indicator = document.getElementById('connectionIndicator');
            const dot = indicator.querySelector('.indicator-dot');
            const text = indicator.querySelector('.indicator-text');
            
            dot.className = 'indicator-dot ' + (connected ? 'connected' : 'disconnected');
            text.textContent = message || (connected ? 'CONNECTED' : 'DISCONNECTED');
        }

        function updatePlaybackButtonHighlights(isPlaying, isPaused) {
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');

            playBtn.classList.toggle('active-state', Boolean(isPlaying));
            pauseBtn.classList.toggle('active-state', Boolean(isPaused));
        }
        
        function fetchRadioState() {
            fetch(`${BACKEND_URL}/state`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // State file uses 0-9, UI uses 1-10
                    currentBank = data.bank + 1;
                    currentStation = data.station + 1;
                    currentBankName = data.bank_name || '';
                    currentStationName = data.station_name || '';
                    updateStationInfo();
                    updateKeypadHighlights();
                }
            })
            .catch(err => console.log('Could not fetch radio state:', err));
        }
        
        function fetchCurrentStatus() {
            fetch(`${BACKEND_URL}/status`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateConnectionIndicator(true, 'CONNECTED');
                    
                    // Update volume slider if we got volume data
                    if (data.volume !== undefined) {
                        document.getElementById('volumeSlider').value = data.volume;
                        document.getElementById('volumeValue').textContent = data.volume;
                    }
                    
                    if (data.is_playing && data.current_track) {
                        // Show full text with scrolling if needed
                        updateStationDisplay(data.current_track);
                        updateStatus('NOW PLAYING', 'success');
                    } else if (data.is_paused) {
                        updateStationDisplay('PAUSED');
                        updateStatus('', 'normal');
                    } else if (!data.current_track) {
                        updateStationDisplay('READY');
                        updateStatus('', 'normal');
                    }

                    updatePlaybackButtonHighlights(data.is_playing, data.is_paused);
                } else {
                    updateConnectionIndicator(false, data.error_type === 'timeout' ? 'TIMEOUT' : 'ERROR');
                }
            })
            .catch(err => {
                updateConnectionIndicator(false, 'NO SERVER');
                console.log('Status update failed:', err);
            });
        }
        
        function startStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            statusUpdateInterval = setInterval(() => {
                fetchCurrentStatus();
                fetchRadioState();
            }, 3000);
            fetchCurrentStatus();
            fetchRadioState();
        }
        
        function sendCommand(command) {
            if (isCommandPending) {
                return;
            }
            
            isCommandPending = true;
            setButtonsDisabled(true);
            updateStatus('SENDING...', 'pending');
            
            fetch(`${BACKEND_URL}/command`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command: command})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus('OK', 'success');
                    
                    if (command === 'mpc play' || command.startsWith('radio-play')) {
                        startStatusUpdates();
                    } else if (command === 'mpc pause') {
                        updateStationDisplay('PAUSED');
                        updatePlaybackButtonHighlights(false, true);
                    } else if (command === 'sudo shutdown -h now') {
                        updateStationDisplay('SHUTTING DOWN');
                        updateStatus('GOODBYE', 'success');
                        if (statusUpdateInterval) {
                            clearInterval(statusUpdateInterval);
                            statusUpdateInterval = null;
                        }
                        updateConnectionIndicator(false, 'SHUTTING DOWN');
                    }
                } else {
                    let errorMsg = '';
                    switch(data.error_type) {
                        case 'timeout':
                            errorMsg = 'TIMEOUT';
                            break;
                        case 'command_failed':
                            errorMsg = 'CMD FAILED';
                            break;
                        case 'forbidden_command':
                            errorMsg = 'NOT ALLOWED';
                            break;
                        case 'ssh_not_found':
                            errorMsg = 'NO SSH';
                            break;
                        default:
                            errorMsg = 'ERROR';
                    }
                    updateStatus(errorMsg, 'error');
                }
                
                setTimeout(() => {
                    if (document.getElementById('status').textContent !== 'SENDING...') {
                        if (!statusUpdateInterval) {
                            updateStatus('', 'normal');
                        }
                    }
                }, 3000);
            })
            .catch(err => {
                updateStatus('NO SERVER', 'error');
                console.error('Connection error:', err);
            })
            .finally(() => {
                isCommandPending = false;
                setButtonsDisabled(false);
            });
        }

        function requestShutdown() {
            const confirmed = window.confirm('Power off this radio now?');
            if (!confirmed) {
                return;
            }
            sendCommand('sudo shutdown -h now');
        }
        
        window.addEventListener('load', () => {
            loadFavorites();
            updateKeypadHighlights();
            setTimeout(() => {
                startStatusUpdates();
            }, 1000);
        });
    </script>
</body>
</html>

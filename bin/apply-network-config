#!/bin/bash
set -euo pipefail

SETUP_HELPER="${RADIO_SETUP_HELPER:-/usr/local/lib/radio/setup-ap-manager}"
CONNECT_TIMEOUT_SECONDS="${RADIO_SETUP_JOIN_TIMEOUT_SECONDS:-60}"

if [[ "${EUID}" -ne 0 ]]; then
  echo '{"success":false,"error":"must run as root"}'
  exit 1
fi

PAYLOAD="$(cat)"

readarray -t FIELDS < <(python3 - <<'PY' "$PAYLOAD"
import json
import re
import sys

payload = json.loads(sys.argv[1])
ssid = str(payload.get("ssid", "")).strip()
password = str(payload.get("password", ""))
hostname = str(payload.get("hostname", "")).strip().lower()

if not ssid or len(ssid) > 32:
    raise SystemExit("invalid_ssid")
if len(password) < 8 or len(password) > 63:
    raise SystemExit("invalid_password")
if not re.match(r"^[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?$", hostname):
    raise SystemExit("invalid_hostname")

print(ssid)
print(password)
print(hostname)
PY
)

SSID="${FIELDS[0]}"
PASSWORD="${FIELDS[1]}"
HOSTNAME="${FIELDS[2]}"

if ! command -v nmcli >/dev/null 2>&1; then
  echo '{"success":false,"error":"nmcli not found"}'
  exit 1
fi

if ! command -v hostnamectl >/dev/null 2>&1; then
  echo '{"success":false,"error":"hostnamectl not found"}'
  exit 1
fi

if [[ ! -x "$SETUP_HELPER" ]]; then
  echo '{"success":false,"error":"setup helper missing"}'
  exit 1
fi

CONN_NAME="radio-managed-${SSID// /-}"

nmcli connection delete "$CONN_NAME" >/dev/null 2>&1 || true
nmcli connection add type wifi ifname wlan0 con-name "$CONN_NAME" ssid "$SSID" >/dev/null
nmcli connection modify "$CONN_NAME" wifi-sec.key-mgmt wpa-psk wifi-sec.psk "$PASSWORD" >/dev/null

hostnamectl set-hostname "$HOSTNAME"

if grep -q '^127.0.1.1' /etc/hosts; then
  sed -i "s/^127\.0\.1\.1.*/127.0.1.1\t${HOSTNAME}/" /etc/hosts
else
  printf '127.0.1.1\t%s\n' "$HOSTNAME" >> /etc/hosts
fi

# Tear down setup AP before attempting station join.
"$SETUP_HELPER" disable || true

if ! "$SETUP_HELPER" join "$CONN_NAME"; then
  "$SETUP_HELPER" enable || true
  echo '{"success":false,"error":"failed to activate station wifi","error_type":"join_failed"}'
  exit 1
fi

if "$SETUP_HELPER" wait-online "$CONNECT_TIMEOUT_SECONDS"; then
  rm -f /var/lib/radio/setup-mode
  echo '{"success":true,"message":"Settings applied. Joined Wi-Fi and exited setup mode."}'
  exit 0
fi

"$SETUP_HELPER" enable || true

echo '{"success":false,"error":"wifi connectivity check failed; setup AP re-enabled","error_type":"connectivity_failed"}'
exit 1
